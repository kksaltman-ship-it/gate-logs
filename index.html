<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºå…¥ã‚Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V1.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; margin: 0; padding: 15px; }
        .card { background: #34495e; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn { display: block; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #27ae60; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        .log-entry { background: #ecf0f1; color: #2c3e50; padding: 10px; border-radius: 5px; margin-top: 5px; font-size: 0.9rem; border-left: 5px solid #2980b9; }
        .status-in { color: #2ecc71; font-weight: bold; }
        .status-out { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup-page" style="text-align:center; padding-top:50px;">
        <h2>å‡ºå…¥ã‚Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
        <select id="gateLocation" style="width:80%; padding:15px; font-size:1.2rem; margin-bottom:20px; border-radius:8px;">
            <option value="ç¬¬1ã‚²ãƒ¼ãƒˆ">ç¬¬1ã‚²ãƒ¼ãƒˆ</option>
            <option value="ç¬¬2ã‚²ãƒ¼ãƒˆ">ç¬¬2ã‚²ãƒ¼ãƒˆ</option>
        </select>
        <button onclick="startApp()" class="btn btn-blue">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    </div>

    <div id="main-page" style="display:none;">
        <h3 id="location-display" style="text-align:center;"></h3>
        <div id="reader"></div>
        <div id="result-area" style="margin-top:20px;"></div>
        
        <h4>ğŸš© æœ€è¿‘ã®å‡ºå…¥ã‚Šå±¥æ­´</h4>
        <div id="log-list"></div>
        
        <button onclick="location.reload()" class="btn" style="background:#7f8c8d; margin-top:20px;">ã‚²ãƒ¼ãƒˆé¸æŠã«æˆ»ã‚‹</button>
    </div>

<script>

    let html5QrCode;
    let stayList = JSON.parse(localStorage.getItem('gateStayList')) || {};
    let logs = JSON.parse(localStorage.getItem('gateFullLogs')) || [];
    let isScanning = false; 

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¡¨ç¤ºã‚’æ›´æ–°
    window.onload = () => {
        updateLogDisplay();
        updateStayCount();
    };

    async function startScanner() {
        const readerDiv = document.getElementById('reader');
        readerDiv.style.display = 'block';
        document.getElementById('start-btn').style.display = 'none';

        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 }, 
            (txt) => { 
                if (!isScanning) { 
                    processScan(txt); 
                }
            }
        );
    }

    function processScan(qrText) {
        isScanning = true; 
        
        const info = qrText.split(',');
        if (info.length < 4) {
            setTimeout(() => { isScanning = false; }, 2000); // å½¢å¼ã‚¨ãƒ©ãƒ¼ã§ã‚‚2ç§’å¾…æ©Ÿ
            return;
        }

        // æˆåŠŸã®åˆå›³ï¼ˆãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        if (navigator.vibrate) navigator.vibrate(200);

        const [company, name, carType, carNum] = info;
        const personId = company + name; // IDã‚’ç”Ÿæˆ
        const gate = document.getElementById('gateLocation').value;
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        
        // å…¥é€€åˆ¤å®šã®ãƒ­ã‚¸ãƒƒã‚¯
        let status = "";
        if (!stayList[personId]) {
            status = "å…¥å®¤";
            stayList[personId] = { company, name, time: timeStr };
        } else {
            status = "é€€å®¤";
            delete stayList[personId];
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        localStorage.setItem('gateStayList', JSON.stringify(stayList));
        
        const newLog = { status, company, name, carType, carNum, gate, time: timeStr };
        logs.unshift(newLog);
        if(logs.length > 50) logs.pop();
        localStorage.setItem('gateFullLogs', JSON.stringify(logs));

        // ç”»é¢ã®æ›´æ–°
        displayResult(newLog);
        updateLogDisplay();
        updateStayCount();

        // 3ç§’é–“ãƒ•ãƒªãƒ¼ã‚ºã•ã›ã¦äºŒé‡èª­ã¿å–ã‚Šã‚’å®Œå…¨ã«é˜²ã
        setTimeout(() => {
            isScanning = false;
        }, 3000); 
    }

    function displayResult(log) {
        const area = document.getElementById('latest-result');
        area.innerHTML = `
            <div class="info-card" style="border-left-color: ${log.status === 'å…¥å®¤' ? '#2ecc71' : '#e74c3c'}">
                <div style="font-size:1.2rem; font-weight:bold; text-align:center; border-bottom:1px solid #bdc3c7; margin-bottom:10px;">
                    <span class="${log.status === 'å…¥å®¤' ? 'in' : 'out'}">${log.status}å®Œäº†</span>
                </div>
                <b>${log.company}</b> / ${log.name} æ§˜<br>
                <small>ğŸš— ${log.carType} (${log.carNum})</small><br>
                <small style="color:#7f8c8d;">${log.time} | ${log.gate}</small>
            </div>
        `;
    }

    function updateLogDisplay() {
        const listDiv = document.getElementById('log-list');
        if (logs.length === 0) {
            listDiv.innerHTML = '<div style="color:#7f8c8d; text-align:center;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        listDiv.innerHTML = logs.map(l => `
            <div class="log-entry">
                <span><b class="${l.status === 'å…¥å®¤' ? 'in' : 'out'}">${l.status === 'å…¥å®¤' ? 'å…¥' : 'å‡º'}</b> ${l.name.substring(0,5)} (${l.company.substring(0,5)})</span>
                <span style="color:#7f8c8d;">${l.time}</span>
            </div>
        `).join('');
    }

    function updateStayCount() {
        const count = Object.keys(stayList).length;
        // å±¥æ­´ã‚¿ã‚¤ãƒˆãƒ«ã®æ¨ªã«äººæ•°ã‚’è¡¨ç¤ºã•ã›ã‚‹
        const title = document.querySelector('h4');
        title.innerHTML = `ğŸš© æœ€è¿‘ã®å‹•ã <span style="font-size:0.8rem; background:#f1c40f; color:#000; padding:2px 8px; border-radius:10px; margin-left:10px;">ç¾åœ¨é¤¨å†…: ${count}å</span>`;
    }

    function clearLogs() {
        if(confirm("ã™ã¹ã¦ã®å±¥æ­´ã¨æ»åœ¨æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæœ¬æ—¥ã®æ¥­å‹™çµ‚äº†æ™‚ã«ã®ã¿æ¨å¥¨ï¼‰")) {
            localStorage.clear();
            location.reload();
        }
    }
    
</script>
</body>
</html>
