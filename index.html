<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºå…¥ã‚Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  V1.2</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; margin: 0; padding: 10px; }
        h2, h4 { margin: 10px 0; text-align: center; }
        .setup-box { background: #34495e; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #5d6d7e; }
        .btn { display: block; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; box-sizing: border-box; }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; font-size: 0.8rem; padding: 8px; margin-top: 20px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; display: none; margin-bottom: 15px; }
        .info-card { background: #ecf0f1; color: #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 8px solid #f1c40f; animation: slideIn 0.3s ease-out; }
        .log-container { background: #1a252f; padding: 10px; border-radius: 10px; font-size: 0.85rem; max-height: 200px; overflow-y: auto; }
        .log-entry { padding: 8px 0; border-bottom: 1px solid #2c3e50; display: flex; justify-content: space-between; }
        .in { color: #2ecc71; font-weight: bold; } .out { color: #e74c3c; font-weight: bold; }
        @keyframes slideIn { from {transform: translateY(-10px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>

    <h2>å‡ºå…¥ã‚Šç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</h2>

    <div class="setup-box">
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <label style="flex:1;">ğŸ“ æ‹…å½“ã‚²ãƒ¼ãƒˆ:</label>
            <select id="gateLocation" style="flex:2; padding:8px; border-radius:5px;">
                <option value="ç¬¬1ã‚²ãƒ¼ãƒˆ">ç¬¬1ã‚²ãƒ¼ãƒˆ</option>
                <option value="ç¬¬2ã‚²ãƒ¼ãƒˆ">ç¬¬2ã‚²ãƒ¼ãƒˆ</option>
            </select>
        </div>
        <button id="start-btn" onclick="startScanner()" class="btn btn-blue">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    </div>

    <div id="reader"></div>
    <div id="latest-result"></div>

    <h4>ğŸš© æœ€è¿‘ã®å‹•ã <span id="stay-count" style="font-size:0.8rem; background:#f1c40f; color:#000; padding:2px 8px; border-radius:10px; margin-left:10px;">ç¾åœ¨é¤¨å†…: 0å</span></h4>
    <div id="log-list" class="log-container">
        <div style="color:#7f8c8d; text-align:center;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>

    <button onclick="clearLogs()" class="btn btn-red">âš ï¸ å±¥æ­´ã‚’ã™ã¹ã¦æ¶ˆå»</button>

<script>
    let html5QrCode;
    let stayList = JSON.parse(localStorage.getItem('gateStayList')) || {};
    let logs = JSON.parse(localStorage.getItem('gateFullLogs')) || [];
    let isScanning = false; 

    window.onload = () => {
        updateLogDisplay();
        updateStayCount();
    };

    async function startScanner() {
        try {
            const readerDiv = document.getElementById('reader');
            readerDiv.style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';

            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 }, 
                (txt) => { 
                    if (!isScanning) { 
                        processScan(txt); 
                    }
                }
            );
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
        }
    }

    function processScan(qrText) {
        isScanning = true; 
        const info = qrText.split(',');
        if (info.length < 4) {
            setTimeout(() => { isScanning = false; }, 2000);
            return;
        }

        if (navigator.vibrate) navigator.vibrate(200);

        const [company, name, carType, carNum] = info;
        const personId = company + name;
        const gate = document.getElementById('gateLocation').value;
        const now = new Date();
        const timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2,'0');
        
        let status = "";
        if (!stayList[personId]) {
            status = "å…¥å®¤";
            stayList[personId] = { company, name, time: timeStr };
        } else {
            status = "é€€å®¤";
            delete stayList[personId];
        }

        localStorage.setItem('gateStayList', JSON.stringify(stayList));
        
        const newLog = { status, company, name, carType, carNum, gate, time: timeStr };
        logs.unshift(newLog);
        if(logs.length > 50) logs.pop();
        localStorage.setItem('gateFullLogs', JSON.stringify(logs));

        displayResult(newLog);
        updateLogDisplay();
        updateStayCount();

        setTimeout(() => {
            isScanning = false;
        }, 3000); 
    }

    function displayResult(log) {
        const area = document.getElementById('latest-result');
        area.innerHTML = `
            <div class="info-card" style="border-left-color: ${log.status === 'å…¥å®¤' ? '#2ecc71' : '#e74c3c'}">
                <div style="font-size:1.2rem; font-weight:bold; text-align:center; border-bottom:1px solid #bdc3c7; margin-bottom:10px;">
                    <span class="${log.status === 'å…¥å®¤' ? 'in' : 'out'}">${log.status}å®Œäº†</span>
                </div>
                <b>${log.company}</b> / ${log.name} æ§˜<br>
                <small>ğŸš— ${log.carType} (${log.carNum})</small><br>
                <small style="color:#7f8c8d;">${log.time} | ${log.gate}</small>
            </div>
        `;
    }

    function updateLogDisplay() {
        const listDiv = document.getElementById('log-list');
        if (logs.length === 0) return;
        listDiv.innerHTML = logs.map(l => `
            <div class="log-entry">
                <span><b class="${l.status === 'å…¥å®¤' ? 'in' : 'out'}">${l.status === 'å…¥å®¤' ? 'å…¥' : 'å‡º'}</b> ${l.name} (${l.company})</span>
                <span style="color:#7f8c8d;">${l.time}</span>
            </div>
        `).join('');
    }

    function updateStayCount() {
        const count = Object.keys(stayList).length;
        document.getElementById('stay-count').innerText = "ç¾åœ¨é¤¨å†…: " + count + "å";
    }

    function clearLogs() {
        if(confirm("ã™ã¹ã¦ã®å±¥æ­´ã¨æ»åœ¨æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
